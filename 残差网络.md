# 残差网络

   残差网络（Residual Network简称ResNet）是在2015年继Alexnet Googlenet VGG三个经典的CNN网络之后提出的，并在ImageNet比赛classification任务上拔得头筹，ResNet因其简单又实用的优点，现已在检测，分割，识别等领域被广泛的应用。<br />    ResNet可以说是过去几年中计算机视觉和深度学习领域最具开创性的工作,有效的解决了随着网络的加深，出现了训练集准确率下降的问题，如下图所示：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561471243660-6a450746-964b-4e46-936e-624ad11b0e52.png#align=left&display=inline&height=231&name=image.png&originHeight=266&originWidth=396&size=21761&status=done&width=344)![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561471361969-e5fba1a8-dd85-40de-b236-e8b268b59661.png#align=left&display=inline&height=241&name=image.png&originHeight=258&originWidth=369&size=18371&status=done&width=344)<br />Fig. 1<br />  图中56层的普通神经网络在训练集上的表现明显的比20层的差很多，从而导致在测试集上的表现也相对较差。<br />
<br />做过深度学习的同学应该都知道，随着网络层数的增加而导致训练效果变差的一个原因是梯度弥散和梯度爆炸问题(vanishing/exploding gradients)，这个问题抑制了浅层网络参数的收敛。但是这个问题已经通过一些参数初始化的技术较好的解决了，有兴趣的同学可以看参考文献[2][3][4][5][6]。<br />但是即便如此，在网络深度较高的时候(例如图中的56层网络)任然会出现效果变差的问题，我们在先前的Alexnet Googlenet VGG三个模型中可以看出，网络的深度在图片的识别中有着至关重要的作用，深度越深能自动学习到的不同层次的特征可能就越多，那到底是什么原因导致了效果变差呢？<br />ResNet的提出者做出了这样的假设：如果一个深层的网络在训练的时候能够训练成一个浅层的网络加上一堆恒等映射的网络，那这样的得到的深层网络在训练的误差上是不会比这个浅层的网络还要高的，所以问题的根源可能在于当网络深度较深的时候，多层的非线性的网络在拟合恒等映射的时候遇到了困难，于是就提出了一种“短路”（shortcut connections）的模型来帮助神经网络的拟合，如下图所示：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561476193643-7fa3a9cc-85e9-49da-9f6f-491bbd11990a.png#align=left&display=inline&height=180&name=image.png&originHeight=248&originWidth=482&size=22726&status=done&width=349)<br />     Fig. 2<br />假设![](https://cdn.nlark.com/yuque/__latex/355b078226649f1cf244ee0f59eeaf3a.svg#card=math&code=H%28x%29&height=24&width=37)是我们最终要拟合的函数，则令 ![](https://cdn.nlark.com/yuque/__latex/54d65742ef351ebf8b11a1887faf31e7.svg#card=math&code=H%28x%29%3DF%28x%29%2Bx&height=24&width=121) 其中![](https://cdn.nlark.com/yuque/__latex/d76f2c4d6bdf142af5106c3f36e9e970.svg#card=math&code=F%28x%29&height=24&width=34)代表普通的堆叠起来的网络拟合出来的函数，![](https://cdn.nlark.com/yuque/__latex/9dd4e461268c8034f5c8564e155c67a6.svg#card=math&code=x&height=24&width=9) 是输入，普通网络的激活函数用的是ReLU函数。非常简单的一个结构，整个网络就是普通网络加上一个恒等映射，普通网络只是整个网络的一部分（![](https://cdn.nlark.com/yuque/__latex/b713db8c4efe4c1a7a3304d256f9b194.svg#card=math&code=F%28x%29%3DH%28x%29-x&height=24&width=121)），这也是 Residual （剩余的）名字的由来。由上述结构可以得到公式：<br />![](https://cdn.nlark.com/yuque/__latex/2921b6d8757b1d34ca7d7e8382901f5f.svg#card=math&code=y%3DF%28x%2C%5C%7BW_i%5C%7D%29%2Bx&height=24&width=137)                                                           ![](https://cdn.nlark.com/yuque/__latex/7acce3193127d4b71a6c2b140c22dc95.svg#card=math&code=%281%29&height=24&width=21)<br />这里的 ![](https://cdn.nlark.com/yuque/__latex/415290769594460e2e485922904f345d.svg#card=math&code=y&height=24&width=8) 是输出，![](https://cdn.nlark.com/yuque/__latex/9dd4e461268c8034f5c8564e155c67a6.svg#card=math&code=x&height=24&width=9) 是输入，![](https://cdn.nlark.com/yuque/__latex/f3e5dd0b1dc61a00993478289fd822ff.svg#card=math&code=F%28x%2C%5C%7BW_i%5C%7D%29&height=24&width=79) 是图中“短路”的起点和终点之间的网络所要拟合的函数，![](https://cdn.nlark.com/yuque/__latex/540bdf656419f2a308d7ad1571c664a0.svg#card=math&code=W_i&height=24&width=21)<br />是第 ![](https://cdn.nlark.com/yuque/__latex/865c0c0b4ab0e063e5caa3387c1a8741.svg#card=math&code=i&height=24&width=5) 层的系数矩阵。图中是用的普通的网络，但对于卷积网络这种结构也同样适用。对于这个公式需要注意的 一点是这里的输入和输出可能是不同维度的，需要用一个线性映射解决这个问题：<br />                                            ![](https://cdn.nlark.com/yuque/__latex/4add77731b95d49a23c4088d209b81fe.svg#card=math&code=y%3DF%28x%2C%5C%7BW_i%5C%7D%29%2BW_sx&height=24&width=160)                                                      ![](https://cdn.nlark.com/yuque/__latex/e4b00b4a65a415cf9ebaa9f83719c071.svg#card=math&code=%282%29&height=24&width=21)<br />这里 ![](https://cdn.nlark.com/yuque/__latex/bc09fe19e1165de9c3bdd48f49ab36a1.svg#card=math&code=W_s&height=24&width=23) w也是系数矩阵。<br />下面我们来看作者设计的34层ResNet的结构与VGG网络结构的对比（参加比赛使用的网络达到了152层）：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561703609123-33f446bd-18ab-4258-a0a8-dc799f2684a5.png#align=left&display=inline&height=629&name=image.png&originHeight=767&originWidth=383&size=74204&status=done&width=314)<br />Fig. 3<br />左侧19层的VGG模型的计算量是 19.6 billion FLOPs 中间是34层的普通卷积网络计算量是3.6 billion FLOPs<br />右边是34层的ResNet计算量是3.6billion FLOPs，图中实线的箭头是没有维度变化的直接映射，虚线是有维度变化的映射。通过对比可以看出VGG虽然层数不多但是计算量还是很大的，后面我们可以通过实验数据看到34层的ResNet的表现会比19层的更好。<br />更详细的结构如下图所示（包括一些层数更多的ResNet）：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561705484787-7f138544-f209-42a2-a4c5-c6551f4aa5a6.png#align=left&display=inline&height=275&name=image.png&originHeight=373&originWidth=846&size=63694&status=done&width=623)<br />Fig. 4<br />
<br />残差网络虽然在结构和原理上都非常简单，但表现不俗且解决了随着深度增加效果变差的问题，下面是实验数据：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561942424599-6b9a62c9-9999-457e-ab6f-0ad3503bcf5b.png#align=left&display=inline&height=428&name=image.png&originHeight=428&originWidth=1356&size=101322&status=done&width=1356)                                                                            Fig. 5<br />这是普通网络（左）和残差网络（右）的对比，图中细线代表训练误差，粗线代表检验误差，蓝色是18层，红色是34层。从图中可以看出普通网络是存在较深的网络比浅的网络效果差的问题，而残差网络却是层数越高效果越好。<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561909717765-d3000c4d-7e97-4765-aa62-54cc4792a6bb.png#align=left&display=inline&height=321&name=image.png&originHeight=450&originWidth=562&size=71091&status=done&width=401)<br />Fig. 6<br />这是残差网络,VGG和GoogleNet在ImageNet数据集上的测是数据，top-1 err表示1000种类别中分类错误的概率，top-5 err 表示1000种类别中网络得出的最有可能的5种类别中任然没有正确类别的概率。图中34层A,B,C是指上文提到的输入输出维度不一致问题中当卷积层之间维度变高的时候采取的三种方案，A是将所有增加的维度都用0填充。（zero-padding）B 是保持原始输入，增加的维度用线性映射填充。C 是将所有的输入都进行线性映射再加到输出中。<br />从图中可以看出在效果上，34层的残差网络比VGG和GoogleNet都要好，A，B，C三种方案中C方案效果最好，但是B，C方案在计算量上比A方案要大很多，而效果提升的又很少，所以论文作者建议还是使用A方案较为实用。<br />下面我们介绍层数在50及以上的残差网络的结构: Deeper Bottleneck Architectures。这种结构是作者为了降低训练时间所设计的，结构对比如下图所示：<br />![image.png](https://cdn.nlark.com/yuque/0/2019/png/388662/1561909496528-ca164b0b-6eb8-492e-a9da-7a1096046bfd.png#align=left&display=inline&height=187&name=image.png&originHeight=286&originWidth=705&size=26939&status=done&width=462)<br />Fig. 7<br />图中左边是34层ResNet使用的普通的结构，右边是50层及以上的所使用的瓶颈（Bottleneck）结构，<br />这里的瓶颈结构中有两个1X1但通道数分别为64和256，第一个是将256通道的输入降维到64通道，第二个是将64通道升维到256通道。中间是普通的3X3的卷积网络，最后整体的计算量与左边的相近。这样的结构的好处是在卷积的同时就完成了维度上的适应，输入可以直接加到输出上，这样可以让计算量减少一半之多。在图5中有50层网络的整个结构，总共的计算量为 3.8 billion FLOPs 只比34层的多0.2 个billion。<br />同样的在图4和图5中可以看出101层和152层的残差网络也用这种结构在计算量上比16层的VGG还要少，而在准确度上比VGG高出许多。
<a name="YbSSn"></a>
###     总结：
ResNet通过残差学习解决了深度网络的退化问题，让我们可以训练出更深的网络，这称得上是深度网络的一个历史大突破吧。也许不久会有更好的方式来训练更深的网络，让我们一起期待吧！<br />目前，您可以在[人工智能建模平台 Mo](https://momodel.cn/) 找到基于tensorflow 的34层的残差网络（ResNet）实现样例，数据集是CIFAR-10 （CIFAR的十分类数据集），这个样例在测试集上的精度为90%，验证集上的精度为98%。主程序在ResNet_Operator.py中,网络的Block结构在ResNet_Block.py中，训练完的模型保存在results文件夹中。<br />项目源码地址：[https://momodel.cn/explore/5d1b0a031afd944132a0797d?type=app](https://momodel.cn/explore/5d1b0a031afd944132a0797d?type=app)<br />
<br />
<br />参考文献：<br />[1] _K. He, X. Zhang, S. Ren, and J. Sun. Deep residual learning for image recognition. arXiv preprint arXiv:1512.03385,2015._<br />[2] Y. LeCun, L. Bottou, G. B. Orr, and K.-R.M¨uller. Efficient backprop.In Neural Networks: Tricks of the Trade, pages 9–50. Springer, 1998.<br />[3] X. Glorot and Y. Bengio. Understanding the difficulty of training deep feedforward neural networks. In AISTATS, 2010.<br />[4] A. M. Saxe, J. L. McClelland, and S. Ganguli. Exact solutions to the nonlinear dynamics of learning in deep linear neural networks.arXiv:1312.6120, 2013.<br />[5] K. He, X. Zhang, S. Ren, and J. Sun. Delving deep into rectifiers:Surpassing human-level performance         on imagenet classification. In ICCV, 2015.<br />[6] S. Ioffe and C. Szegedy. Batch normalization: Accelerating deep network training by reducing internal covariate shift. In ICML, 2015.<br />

<a name="oxtTX"></a>
### 关于我们
**Mo**（网址：[**momodel.cn**](https://momodel.cn/)）是一个支持 Python 的**人工智能在线建模平台**，能帮助你快速开发、训练并部署模型。

---

**Mo 人工智能俱乐部** 是由网站的研发与产品设计团队发起、致力于降低人工智能开发与使用门槛的俱乐部。团队具备大数据处理分析、可视化与数据建模经验，已承担多领域智能项目，具备从底层到前端的全线设计开发能力。主要研究方向为大数据管理分析与人工智能技术，并以此来促进数据驱动的科学研究。

目前俱乐部每周六在杭州举办以机器学习为主题的线下技术沙龙活动，定期进行论文分享与学术交流。希望能汇聚来自各行各业对人工智能感兴趣的朋友，不断交流共同成长，推动人工智能民主化、应用普及化。<br />!
 <div>
    <h3>微信公众号: MomodelAI</h3>
    <img src='https://mo-imgs.momodel.cn/WeChatPublicAccount.png' height="220"/>
 </div>
 <br/>
 <br/>
<div>
    <h3>添加管理员微信加入AI俱乐部群聊</h3>
    <img src='https://mo-imgs.momodel.cn/wechat_office_contact.png' height="210">
</div>



